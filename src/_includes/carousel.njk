<section class="container mx-auto h-almost-full py-4 md:py-10 px-5">
  <div class="carousel h-full relative">
    {% for item in data.carouselPosts %}
      <a
        href="/post/{{ item.slug }}/"
        id="carousel-item-{{ loop.index }}"
        class="carousel-item absolute inset-0 bg-center bg-cover flex flex-col justify-end p-10 text-white rounded-xl transition-opacity duration-1000 ease-in-out{% if loop.first %} opacity-100 z-10{% else %} opacity-0{% endif %}"
        style="background-image: linear-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.3)), url('{{ item.imagePostCarousel.url }}')"
      >
        <h2 class="text-3xl font-bold mb-4 md:w-2/3">
          {{ item.title }}
        </h2>
        <div class="flex items-center text-sm">
          <span class="mr-1">
            <svg stroke="#fff" fill="#fff" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg">
              <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"></path>
            </svg>
          </span>
          <span>{{ item.publishedAt | date_to_long_string }}</span>
        </div>
      </a>
    {% endfor %}
    <div class="absolute inset-y-0 right-0 w-1/4 z-20 hidden lg:flex flex-col justify-around cursor-pointer">
      {% for item in data.carouselPosts %}
        <div id="carousel-item-thumbnail-{{ loop.index }}" class="flex items-center">
          <div class="w-1/5">
            <img class="h-14 rounded-full" src="{{ item.imagePostCarouselThumbnail.url }}" alt="" loading="lazy">
          </div>
          <div
            class="w-4/5 px-4"
            style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;"
          >
            <p class="carousel-item-thumbnail-title font-bold text-white{% if loop.first %} opacity-100{% else %} opacity-50{% endif %}">
              {{ item.title }}
            </p>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</section>

<script>

  const duration = 4000;
  let currentItemIndex = 1;
  let nextItemIndex = 2;

  if (document.querySelector(".carousel")) {
    for (let i = 1; i <= "{{ data.carouselPosts.length }}"; ++i) {
      const thumbnailItem = document.querySelector(`#carousel-item-thumbnail-${i}`);

      thumbnailItem.addEventListener('click', event => {
        const currentItem = document.querySelector(`.carousel-item.opacity-100`);
        const nextItem = document.querySelector(`#carousel-item-${i}`);
        const currentItemThumbnailTitle = document.querySelector(`.carousel-item-thumbnail-title.opacity-100`);
        const nextItemThumbnailTitle = document.querySelector(`#carousel-item-thumbnail-${i} .carousel-item-thumbnail-title`);

        changeItemVisibility(currentItem, nextItem);
        changeItemThumbnailTitleVisibility(currentItemThumbnailTitle, nextItemThumbnailTitle);

        currentItemIndex = i;
        nextItemIndex = (i === {{ data.carouselPosts.length }}) ? 1 : i + 1;

        clearInterval(timer);
        timer = setInterval(changeItems, duration);
      });
    }

    let timer = setInterval(changeItems, duration);
  }

  function changeItemVisibility(currentItem, nextItem) {
    currentItem.classList.remove("opacity-100");
    currentItem.classList.remove("z-10");
    currentItem.classList.add("opacity-0");
    nextItem.classList.remove("opacity-0");
    nextItem.classList.add("opacity-100");
    nextItem.classList.add("z-10");
  }

  function changeItemThumbnailTitleVisibility(currentItemThumbnailTitle, nextItemThumbnailTitle) {
    currentItemThumbnailTitle.classList.remove("opacity-100");
    currentItemThumbnailTitle.classList.add("opacity-50");
    nextItemThumbnailTitle.classList.remove("opacity-50");
    nextItemThumbnailTitle.classList.add("opacity-100");
  }

  function changeItems() {
    const currentItem = document.querySelector(`#carousel-item-${currentItemIndex}`);
    const nextItem = document.querySelector(`#carousel-item-${nextItemIndex}`);
    const currentItemThumbnailTitle = document.querySelector(`#carousel-item-thumbnail-${currentItemIndex} .carousel-item-thumbnail-title`);
    const nextItemThumbnailTitle = document.querySelector(`#carousel-item-thumbnail-${nextItemIndex} .carousel-item-thumbnail-title`);

    changeItemVisibility(currentItem, nextItem);
    changeItemThumbnailTitleVisibility(currentItemThumbnailTitle, nextItemThumbnailTitle);
    
    if (currentItemIndex === {{ data.carouselPosts.length }}) {
      currentItemIndex = 1;
    } else {
      ++currentItemIndex;
    }

    if (nextItemIndex === {{ data.carouselPosts.length }}) {
      nextItemIndex = 1;
    } else {
      ++nextItemIndex;
    }
  }
</script>
